{"Id":11,"Title":"诱惑","Slug":"youhuo","Text":"    // @system SHOP-YUN \u003cshop-yun.com\u003e\n    // @version shop-yun 1.0\n    // @author xiaotangren  \u003cunphp@qq.com\u003e\n    // @data 2014-07-21\n    \n    package main\n    \n    import (\n        \"bufio\"\n        \"fmt\"\n        \"os\"\n        \"shop-yun.go/go-core/utils/log\"\n        \"time\"\n    )\n    \n    func main() {\n    \n        switch RunMode {\n        case \"api\":\n            initApiService()\n        case \"web\":\n            initWebService()\n        default:\n            initApiService()\n        }\n    \n        //启动系统日志\n        listen(RootPath+\"/\"+ConfData.Get(\"core\", \"logpath\").String(), Log)\n        //系统结束前执行的\n        defer func() {\n            for _, fun := range ServerDeferFuncSlice {\n                fun()\n            }\n        }()\n    \n    }\n    \n    //监听服务运行状态，记录服务日志。\n    func listen(logpath string, Log *log.Log) {\n        oldStr := time.Now().Format(\"2006-01-02\")\n        files := openLogFile(logpath, oldStr)\n        var logwriter *bufio.Writer\n        logwriter = bufio.NewWriter(files)\n        logwriter.WriteString(\"-------------------服务开始启动--------------------\" + \"\\r\\n\")\n        logwriter.WriteString(\"Date:\" + time.Now().Format(\"2006-01-02 15:04:05\") + \"\\r\\n\")\n        logwriter.Flush()\n        for {\n            nowStr := time.Now().Format(\"2006-01-02\")\n            if nowStr != oldStr {\n                oldStr = nowStr\n                files.Close()\n                files = openLogFile(logpath, nowStr)\n                logwriter = bufio.NewWriter(files)\n            }\n            select {\n            case msg := \u003c-Log.ChanLogMsg:\n                for _, v := range msg {\n                    fmt.Println(v)\n                    logwriter.WriteString(v + \"\\r\\n\")\n                }\n                logwriter.Flush()\n            default:\n            }\n            time.Sleep(1 * time.Second)\n        }\n    }\n    \n    func openLogFile(logpath, n string) *os.File {\n        logPath := logpath + \"/syslog/\" + RunMode\n        //fmt.Println(logPath)\n        os.MkdirAll(logPath, 0755)\n        files, _ := os.OpenFile(logPath+\"/\"+n, os.O_WRONLY|os.O_APPEND|os.O_CREATE, 0644)\n        return files\n    }\n\n![Alt 美女](/static/upload/201411131704189.jpg)","Tags":["golang"],"CreateTime":1415869705,"EditTime":1415870828,"UpdateTime":1415869705,"IsComment":true,"IsLinked":false,"AuthorId":5,"Template":"blog.html","Type":"article","Status":"DELETE","Format":"markdown","Comments":[],"Hits":7}